name: Update EPG

on:
  schedule:
    - cron: "0 4 * * *"  # 05:00 CET / 06:00 CEST
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update_epg:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    concurrency:
      group: epg-update
      cancel-in-progress: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clone iptv-org/epg
        run: |
          git clone --depth 1 https://github.com/iptv-org/epg.git

      - name: Set up Node.js (cache npm su epg/)
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: epg/package-lock.json

      - name: Install grabber deps
        working-directory: ./epg
        run: npm ci --no-audit --no-fund

      - name: Grab EPG
        env:
          CHANNELS_FILE: ${{ github.workspace }}/channels.xml
          OUTPUT_FILE:   ${{ github.workspace }}/epg.xml
        run: |
          pushd epg
          npm run grab -- \
            --channels="$CHANNELS_FILE" \
            --days 7 \
            --maxConnections 16 \
            --timeout 15000 \
            --output "$OUTPUT_FILE"
          popd
          echo "---- EPG SUMMARY ----"
          if [ -f "$OUTPUT_FILE" ]; then
            channels_count=$(grep -c "<channel" "$OUTPUT_FILE" || true)
            progs_count=$(grep -c "<programme " "$OUTPUT_FILE" || true)
            echo "Channels: $channels_count"
            echo "Programmes: $progs_count"
            ls -lh "$OUTPUT_FILE"
          else
            echo "No epg.xml produced."
            exit 1
          fi

      - name: Commit changes if needed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add epg.xml || true
          if ! git diff --cached --quiet; then
            git commit -m "EPG Updated! ðŸ“º"
            git push
          else
            echo "No EPG changes to commit."
          fi
